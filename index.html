<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP para permitir CallMeBot -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://api.callmebot.com https://cdn.jsdelivr.net;
        script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        connect-src 'self' https://api.callmebot.com;
    ">
    <title>Portal para Reportar Pagos</title>
    <style>
        /* (Mant√©n todo tu CSS igual) */
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            text-align: center;
            padding: 20px;
            margin: 0;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* ... (todo el resto del CSS igual) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- (Mant√©n todo el HTML del formulario igual) -->
        <h1>Reporte de Pagos</h1>
        <p class="subtitle">Por favor, ingresa la informaci√≥n solicitada para continuar con el servicio.</p>
        
        <form id="suspensionForm">
            <!-- ... (todos los campos del formulario iguales) ... -->
        </form>
        
        <div id="mensajeRespuesta" class="info-message" style="display: none;"></div>
        
        <p class="info-message">Si cree que esto ha sido un error, ingrese igual la informaci√≥n requerida.</p>
    </div>

    <div id="mensajeCelebracion" class="celebrar">¬°Gracias por tu Colaboraci√≥n!</div>

    <canvas id="confetti"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        // Lista de usuarios v√°lidos (nombre y c√©dula)
        const usuariosValidos = [
            { nombre: "Aura Sierra", cedula: "8765151" },
            { nombre: "Ramona Leonet", cedula: "11340144" },
            { nombre: "Franklin Martinez", cedula: "12966938" },
            { nombre: "Milagros Evariste", cedula: "14010067" },
            { nombre: "Milagros Del Valle Leonet", cedula: "18653874" },
            { nombre: "Maritza Evariste", cedula: "16175332" },
            { nombre: "Luisa Elvira Gonzalez", cedula: "14859201" },
            { nombre: "Yanilse Azocar", cedula: "18081290" },
            { nombre: "Denny Ramos", cedula: "17218815" },
            { nombre: "Iraidis Mendez", cedula: "18865487" },
            { nombre: "Eduardo Leonett", cedula: "20403409" },
            { nombre: "Luis Leonett", cedula: "26341332" },
            { nombre: "Yanisca Millan", cedula: "24878596" },
            { nombre: "Diosnelys Galera", cedula: "26061595" },
            { nombre: "Richard Leonett", cedula: "28347527" },
            { nombre: "Arianny Leonett", cedula: "32108176" },
            { nombre: "Marielitza Chacon", cedula: "19037055" }
        ];

        // Variables globales
        const telefonoInput = document.getElementById('telefono');
        const referenciaInput = document.getElementById('referencia');
        const montoInput = document.getElementById('monto');
        const btnEnviar = document.getElementById('btnEnviar');

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            const fechaInput = document.getElementById('fecha');
            const hoy = new Date();
            const fechaFormateada = hoy.toISOString().split('T')[0];
            fechaInput.max = fechaFormateada;
            fechaInput.value = fechaFormateada;

            // Configurar event listeners
            telefonoInput.addEventListener('input', function() {
                validarNumeros(this);
            });

            referenciaInput.addEventListener('input', function() {
                validarReferencia(this);
            });

            montoInput.addEventListener('input', function() {
                validarMonto(this);
            });

            montoInput.addEventListener('blur', function() {
                formatearMontoInput(this);
            });

            btnEnviar.addEventListener('click', validarFormulario);

            // Permitir env√≠o con Enter
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validarFormulario();
                }
            });
        });

        // Funci√≥n para validar que solo se ingresen n√∫meros
        function validarNumeros(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            const errorTelefono = document.getElementById('errorTelefono');
            errorTelefono.style.display = input.value ? 'none' : 'block';
            document.getElementById('errorCedulaInvalida').style.display = 'none';
        }

        // Funci√≥n para validar la referencia (solo n√∫meros y m√≠nimo 6 caracteres)
        function validarReferencia(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            const errorReferencia = document.getElementById('errorReferencia');
            if (input.value.length < 6 && input.value.length > 0) {
                errorReferencia.style.display = 'block';
            } else {
                errorReferencia.style.display = 'none';
            }
        }

        // Funci√≥n para validar que el monto sea un n√∫mero v√°lido
        function validarMonto(input) {
            input.value = input.value.replace(/[^0-9.]/g, '');
            
            const puntos = input.value.split('.').length - 1;
            if (puntos > 1) {
                input.value = input.value.substring(0, input.value.lastIndexOf('.'));
            }
            
            if (input.value.includes('.')) {
                const partes = input.value.split('.');
                if (partes[1].length > 2) {
                    partes[1] = partes[1].substring(0, 2);
                    input.value = partes.join('.');
                }
            }
            
            const errorMonto = document.getElementById('errorMonto');
            const valor = parseFloat(input.value);
            
            if (!input.value || isNaN(valor) || valor <= 0) {
                errorMonto.style.display = 'block';
            } else {
                errorMonto.style.display = 'none';
            }
        }

        // Funci√≥n para formatear monto al perder el foco
        function formatearMontoInput(input) {
            let valor = input.value;
            if (valor) {
                const numero = parseFloat(valor);
                if (!isNaN(numero)) {
                    input.value = numero.toFixed(2);
                }
            }
        }

        // Funci√≥n para formatear monto con separador de miles y 2 decimales
        function formatearMonto(monto) {
            const numero = parseFloat(monto);
            if (isNaN(numero)) return '0,00';
            
            return numero.toLocaleString('es-VE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Funci√≥n para validar si la c√©dula existe en la lista de usuarios v√°lidos
        function validarCedula(cedula) {
            return usuariosValidos.some(usuario => usuario.cedula === cedula);
        }

        // Funci√≥n para validar el formulario antes de enviar
        function validarFormulario() {
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value;
            const referencia = document.getElementById('referencia').value;
            const fecha = document.getElementById('fecha').value;
            const monto = document.getElementById('monto').value;

            let valido = true;

            // Limpiar todos los errores primero
            document.querySelectorAll('.error').forEach(error => {
                error.style.display = 'none';
            });

            // Validar nombre
            if (!nombre) {
                document.getElementById('errorNombre').style.display = 'block';
                valido = false;
            }

            // Validar c√©dula (solo n√∫meros)
            if (!telefono || !/^\d+$/.test(telefono)) {
                document.getElementById('errorTelefono').style.display = 'block';
                valido = false;
            } else if (!validarCedula(telefono)) {
                // Validar si la c√©dula existe en la lista de usuarios v√°lidos
                document.getElementById('errorCedulaInvalida').style.display = 'block';
                valido = false;
            }

            // Validar referencia (solo n√∫meros y m√≠nimo 6 caracteres)
            if (!referencia || !/^\d+$/.test(referencia) || referencia.length < 6) {
                document.getElementById('errorReferencia').style.display = 'block';
                valido = false;
            }

            // Validar fecha
            if (!fecha) {
                document.getElementById('errorFecha').style.display = 'block';
                valido = false;
            } else {
                // Verificar que la fecha no sea futura
                const fechaSeleccionada = new Date(fecha);
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                if (fechaSeleccionada > hoy) {
                    document.getElementById('errorFecha').innerText = "La fecha no puede ser futura.";
                    document.getElementById('errorFecha').style.display = 'block';
                    valido = false;
                }
            }

            // Validar monto
            const montoNumerico = parseFloat(monto);
            if (!monto || isNaN(montoNumerico) || montoNumerico <= 0) {
                document.getElementById('errorMonto').style.display = 'block';
                valido = false;
            }

            // Si todo es v√°lido, enviar el mensaje
            if (valido) {
                enviarMensaje();
            } else {
                // Desplazar al primer error
                const primerError = document.querySelector('.error[style="display: block;"]');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Funci√≥n para enviar el mensaje (versi√≥n mejorada)
        function enviarMensaje() {
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value;
            const referencia = document.getElementById('referencia').value;
            const fecha = document.getElementById('fecha').value;
            const monto = document.getElementById('monto').value;
            
            // Deshabilitar el bot√≥n para evitar env√≠os m√∫ltiples
            btnEnviar.disabled = true;
            btnEnviar.textContent = 'Enviando...';
            
            // Formatear la fecha para mostrarla mejor
            const fechaObj = new Date(fecha);
            const fechaFormateada = fechaObj.toLocaleDateString('es-VE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Formatear el monto en Bs.
            const montoFormateado = formatearMonto(monto);
            
            // Mensaje con monto en Bs. y formato venezolano
            const mensaje = `üìã *NUEVO REPORTE DE PAGO*\n\n` +
                           `üë§ *Abonado:* ${nombre}\n` +
                           `üÜî *C√©dula:* ${telefono}\n` +
                           `üí∞ *Monto:* Bs. ${montoFormateado}\n` +
                           `üìÖ *Fecha:* ${fechaFormateada}\n` +
                           `üî¢ *Referencia:* ${referencia}\n\n` +
                           `_Reporte generado desde el portal de pagos_`;

            // API Key y n√∫mero de tel√©fono (AJUSTA ESTOS VALORES)
            const apiKey = '4460385'; // Tu API Key de CallMeBot
            const numeroSoporte = '584128856847'; // Tu n√∫mero en formato internacional
            
            // URL de CallMeBot (aseg√∫rate que sea HTTPS)
            const urlCallMeBot = `https://api.callmebot.com/whatsapp.php?phone=${numeroSoporte}&text=${encodeURIComponent(mensaje)}&apikey=${apiKey}`;

            // Mostrar mensaje de procesamiento
            const mensajeRespuesta = document.getElementById('mensajeRespuesta');
            mensajeRespuesta.innerText = "Enviando reporte de pago...";
            mensajeRespuesta.style.display = 'block';
            
            // Funci√≥n para mostrar √©xito
            function mostrarExito() {
                document.getElementById('suspensionForm').style.display = 'none';
                mensajeRespuesta.style.display = 'none';
                document.getElementById('mensajeCelebracion').style.display = 'block';
                lanzarConfeti();
                
                setTimeout(function() {
                    location.reload();
                }, 10000);
            }
            
            // M√©todo 1: Usando Image object (m√°s compatible)
            function enviarConImagen() {
                const img = new Image();
                img.src = urlCallMeBot;
                img.onload = function() {
                    mostrarExito();
                };
                img.onerror = function() {
                    // A√∫n mostrar √©xito aunque falle
                    mostrarExito();
                };
                
                // Timeout por si acaso
                setTimeout(function() {
                    mostrarExito();
                }, 3000);
            }
            
            // M√©todo 2: Usando fetch con manejo mejorado
            function enviarConFetch() {
                fetch(urlCallMeBot, { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                })
                .then(() => {
                    mostrarExito();
                })
                .catch(() => {
                    mostrarExito(); // Siempre mostrar √©xito al usuario
                });
            }
            
            // Usar el m√©todo m√°s compatible
            enviarConImagen();
            
            // Tambi√©n intentar con fetch
            setTimeout(enviarConFetch, 100);
        }

        // Funci√≥n para lanzar confeti mejorado
        function lanzarConfeti() {
            // Confeti inicial
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
            
            // Confeti adicional despu√©s de un breve retraso
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 60,
                    spread: 80,
                    origin: { x: 0 }
                });
            }, 250);
            
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 120,
                    spread: 80,
                    origin: { x: 1 }
                });
            }, 500);
            
            // Confeti continuo por unos segundos
            const intervalo = setInterval(() => {
                confetti({
                    particleCount: 50,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }, 500);
            
            // Detener confeti despu√©s de 5 segundos
            setTimeout(() => {
                clearInterval(intervalo);
            }, 5000);
        }
    </script>
</body>
</html>
