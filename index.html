<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP mejorado para evitar bloqueos -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://api.callmebot.com https://cdn.jsdelivr.net;
        script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://api.callmebot.com;
        font-src 'self';
        frame-src 'none';
        object-src 'none'
    ">
    <title>Portal para Reportar Pagos</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            text-align: center;
            padding: 20px;
            margin: 0;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            margin: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #ff0000;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #333;
            font-size: 16px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        
        input, button {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input {
            background-color: #fff;
            color: #333;
        }
        
        input:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }
        
        input::placeholder {
            color: #888;
        }
        
        .error {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
            display: none;
            min-height: 20px;
        }
        
        button {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            padding: 15px;
            font-size: 18px;
        }
        
        button:hover {
            background: linear-gradient(to right, #128C7E, #25D366);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .celebrar {
            display: none;
            font-size: 36px;
            font-weight: bold;
            color: #25D366;
            animation: celebrar 2s infinite;
            margin: 30px 0;
            text-shadow: 0 0 10px rgba(37, 211, 102, 0.5);
        }
        
        .info-message {
            color: #666;
            font-size: 14px;
            margin-top: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #25D366;
        }
        
        .status-message {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @keyframes celebrar {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Responsividad */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .celebrar {
                font-size: 28px;
            }
        }
        
        /* Estilo para el canvas de confeti */
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reporte de Pagos</h1>
        <p class="subtitle">Por favor, ingresa la informaci√≥n solicitada para continuar con el servicio.</p>
        
        <!-- Mensaje de estado -->
        <div id="statusMessage" class="status-message"></div>
        
        <form id="suspensionForm">
            <div class="form-group">
                <label for="nombre">Nombre del abonado</label>
                <input type="text" id="nombre" placeholder="Ingresa tu nombre completo" required>
                <div id="errorNombre" class="error">Por favor, ingresa tu nombre completo.</div>
            </div>
            
            <div class="form-group">
                <label for="telefono">N√∫mero de c√©dula</label>
                <input type="text" id="telefono" placeholder="Ej: 12345678" required>
                <div id="errorTelefono" class="error">Por favor, ingresa solo n√∫meros.</div>
                <div id="errorCedulaInvalida" class="error">La c√©dula ingresada no est√° registrada en el sistema.</div>
            </div>
            
            <div class="form-group">
                <label for="referencia">Referencia del pago</label>
                <input type="text" id="referencia" placeholder="M√≠nimo 6 d√≠gitos" required>
                <div id="errorReferencia" class="error">La referencia debe tener al menos 6 n√∫meros.</div>
            </div>
            
            <div class="form-group">
                <label for="fecha">Fecha de pago</label>
                <input type="date" id="fecha" required>
                <div id="errorFecha" class="error">Por favor, selecciona una fecha v√°lida.</div>
            </div>
            
            <div class="form-group">
                <label for="monto">Monto pagado (Bs.)</label>
                <input type="text" id="monto" placeholder="Ej: 50.00" required>
                <div id="errorMonto" class="error">Por favor, ingresa un monto v√°lido en Bs. (ej: 50.00).</div>
            </div>
            
            <button type="button" id="btnEnviar">Reportar Pago</button>
        </form>
        
        <div id="mensajeRespuesta" class="info-message" style="display: none;"></div>
        
        <p class="info-message">Si cree que esto ha sido un error, ingrese igual la informaci√≥n requerida.</p>
    </div>

    <!-- Mensaje de celebraci√≥n -->
    <div id="mensajeCelebracion" class="celebrar">¬°Gracias por tu Colaboraci√≥n!</div>

    <!-- Confeti -->
    <canvas id="confetti"></canvas>

    <!-- Confetti desde CDN local para evitar CSP issues -->
    <script>
        // Cargar confetti de forma segura
        function cargarConfetti() {
            if (typeof confetti === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js';
                script.onload = inicializarAplicacion;
                document.head.appendChild(script);
            } else {
                inicializarAplicacion();
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', cargarConfetti);
        } else {
            cargarConfetti();
        }
    </script>

    <script>
        // ================= CONFIGURACI√ìN =================
        // Lista de usuarios v√°lidos (nombre y c√©dula)
        const USUARIOS_VALIDOS = [
            { nombre: "Aura Sierra", cedula: "8765151" },
            { nombre: "Ramona Leonet", cedula: "11340144" },
            { nombre: "Franklin Martinez", cedula: "12966938" },
            { nombre: "Milagros Evariste", cedula: "14010067" },
            { nombre: "Milagros Del Valle Leonet", cedula: "18653874" },
            { nombre: "Maritza Evariste", cedula: "16175332" },
            { nombre: "Luisa Elvira Gonzalez", cedula: "14859201" },
            { nombre: "Yanilse Azocar", cedula: "18081290" },
            { nombre: "Denny Ramos", cedula: "17218815" },
            { nombre: "Iraidis Mendez", cedula: "18865487" },
            { nombre: "Eduardo Leonett", cedula: "20403409" },
            { nombre: "Luis Leonett", cedula: "26341332" },
            { nombre: "Yanisca Millan", cedula: "24878596" },
            { nombre: "Diosnelys Galera", cedula: "26061595" },
            { nombre: "Richard Leonett", cedula: "28347527" },
            { nombre: "Arianny Leonett", cedula: "32108176" },
            { nombre: "Marielitza Chacon", cedula: "19037055" }
        ];

        // Configuraci√≥n de WhatsApp
        const CONFIG = {
            apiKey: '4460385', // Tu API Key de CallMeBot
            numeroSoporte: '584128856847', // Tu n√∫mero en formato internacional
            callmebotUrl: 'https://api.callmebot.com/whatsapp.php'
        };

        // ================= VARIABLES GLOBALES =================
        let elementos = {};

        // ================= INICIALIZACI√ìN =================
        function inicializarAplicacion() {
            // Obtener referencias a elementos DOM
            elementos = {
                fecha: document.getElementById('fecha'),
                telefono: document.getElementById('telefono'),
                referencia: document.getElementById('referencia'),
                monto: document.getElementById('monto'),
                btnEnviar: document.getElementById('btnEnviar'),
                nombre: document.getElementById('nombre'),
                statusMessage: document.getElementById('statusMessage'),
                suspensionForm: document.getElementById('suspensionForm'),
                mensajeCelebracion: document.getElementById('mensajeCelebracion'),
                mensajeRespuesta: document.getElementById('mensajeRespuesta')
            };

            // Verificar que todos los elementos existan
            if (!verificarElementos()) {
                mostrarError('Error: Elementos del formulario no encontrados. Recarga la p√°gina.');
                return;
            }

            // Configurar fecha
            configurarFecha();

            // Configurar event listeners
            configurarEventListeners();

            // Mostrar mensaje de inicializaci√≥n exitosa
            console.log('Aplicaci√≥n inicializada correctamente');
        }

        function verificarElementos() {
            for (const [key, element] of Object.entries(elementos)) {
                if (!element && key !== 'statusMessage' && key !== 'mensajeRespuesta') {
                    console.error(`Elemento ${key} no encontrado`);
                    return false;
                }
            }
            return true;
        }

        function configurarFecha() {
            const hoy = new Date();
            const fechaFormateada = hoy.toISOString().split('T')[0];
            elementos.fecha.max = fechaFormateada;
            elementos.fecha.value = fechaFormateada;
        }

        function configurarEventListeners() {
            // Validaci√≥n en tiempo real
            elementos.telefono.addEventListener('input', () => validarNumeros(elementos.telefono));
            elementos.referencia.addEventListener('input', () => validarReferencia(elementos.referencia));
            elementos.monto.addEventListener('input', () => validarMonto(elementos.monto));
            elementos.monto.addEventListener('blur', () => formatearMontoInput(elementos.monto));
            
            // Env√≠o del formulario
            elementos.btnEnviar.addEventListener('click', validarFormulario);
            
            // Env√≠o con Enter
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    validarFormulario();
                }
            });
        }

        // ================= VALIDACIONES =================
        function validarNumeros(input) {
            if (!input) return;
            input.value = input.value.replace(/[^0-9]/g, '');
            const errorTelefono = document.getElementById('errorTelefono');
            if (errorTelefono) {
                errorTelefono.style.display = input.value ? 'none' : 'block';
            }
            const errorCedulaInvalida = document.getElementById('errorCedulaInvalida');
            if (errorCedulaInvalida) {
                errorCedulaInvalida.style.display = 'none';
            }
        }

        function validarReferencia(input) {
            if (!input) return;
            input.value = input.value.replace(/[^0-9]/g, '');
            const errorReferencia = document.getElementById('errorReferencia');
            if (errorReferencia) {
                if (input.value.length < 6 && input.value.length > 0) {
                    errorReferencia.style.display = 'block';
                } else {
                    errorReferencia.style.display = 'none';
                }
            }
        }

        function validarMonto(input) {
            if (!input) return;
            
            input.value = input.value.replace(/[^0-9.]/g, '');
            
            const puntos = input.value.split('.').length - 1;
            if (puntos > 1) {
                input.value = input.value.substring(0, input.value.lastIndexOf('.'));
            }
            
            if (input.value.includes('.')) {
                const partes = input.value.split('.');
                if (partes[1].length > 2) {
                    partes[1] = partes[1].substring(0, 2);
                    input.value = partes.join('.');
                }
            }
            
            const errorMonto = document.getElementById('errorMonto');
            if (errorMonto) {
                const valor = parseFloat(input.value);
                if (!input.value || isNaN(valor) || valor <= 0) {
                    errorMonto.style.display = 'block';
                } else {
                    errorMonto.style.display = 'none';
                }
            }
        }

        function formatearMontoInput(input) {
            if (!input) return;
            let valor = input.value;
            if (valor) {
                const numero = parseFloat(valor);
                if (!isNaN(numero)) {
                    input.value = numero.toFixed(2);
                }
            }
        }

        function formatearMonto(monto) {
            const numero = parseFloat(monto);
            if (isNaN(numero)) return '0,00';
            
            return numero.toLocaleString('es-VE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function validarCedula(cedula) {
            return USUARIOS_VALIDOS.some(usuario => usuario.cedula === cedula);
        }

        // ================= VALIDACI√ìN DEL FORMULARIO =================
        function validarFormulario() {
            const nombre = elementos.nombre.value.trim();
            const telefono = elementos.telefono.value;
            const referencia = elementos.referencia.value;
            const fecha = elementos.fecha.value;
            const monto = elementos.monto.value;

            let valido = true;

            // Limpiar errores previos
            document.querySelectorAll('.error').forEach(error => {
                if (error) error.style.display = 'none';
            });

            // Validar nombre
            if (!nombre) {
                mostrarErrorElemento('errorNombre', 'Por favor, ingresa tu nombre completo.');
                valido = false;
            }

            // Validar c√©dula
            if (!telefono || !/^\d+$/.test(telefono)) {
                mostrarErrorElemento('errorTelefono', 'Por favor, ingresa solo n√∫meros.');
                valido = false;
            } else if (!validarCedula(telefono)) {
                mostrarErrorElemento('errorCedulaInvalida', 'La c√©dula ingresada no est√° registrada en el sistema.');
                valido = false;
            }

            // Validar referencia
            if (!referencia || !/^\d+$/.test(referencia) || referencia.length < 6) {
                mostrarErrorElemento('errorReferencia', 'La referencia debe tener al menos 6 n√∫meros.');
                valido = false;
            }

            // Validar fecha
            if (!fecha) {
                mostrarErrorElemento('errorFecha', 'Por favor, selecciona una fecha v√°lida.');
                valido = false;
            } else {
                const fechaSeleccionada = new Date(fecha);
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                if (fechaSeleccionada > hoy) {
                    mostrarErrorElemento('errorFecha', 'La fecha no puede ser futura.');
                    valido = false;
                }
            }

            // Validar monto
            const montoNumerico = parseFloat(monto);
            if (!monto || isNaN(montoNumerico) || montoNumerico <= 0) {
                mostrarErrorElemento('errorMonto', 'Por favor, ingresa un monto v√°lido en Bs. (ej: 50.00).');
                valido = false;
            }

            if (valido) {
                enviarMensaje();
            } else {
                const primerError = document.querySelector('.error[style="display: block;"]');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function mostrarErrorElemento(id, mensaje) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = mensaje;
                elemento.style.display = 'block';
            }
        }

        // ================= ENV√çO DE MENSAJE =================
        async function enviarMensaje() {
            const nombre = elementos.nombre.value.trim();
            const telefono = elementos.telefono.value;
            const referencia = elementos.referencia.value;
            const fecha = elementos.fecha.value;
            const monto = elementos.monto.value;
            
            // Deshabilitar bot√≥n
            elementos.btnEnviar.disabled = true;
            elementos.btnEnviar.textContent = 'Enviando...';
            
            // Formatear datos
            const fechaObj = new Date(fecha);
            const fechaFormateada = fechaObj.toLocaleDateString('es-VE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            const montoFormateado = formatearMonto(monto);
            
            // Crear mensaje
            const mensaje = `üìã *NUEVO REPORTE DE PAGO*\n\n` +
                           `üë§ *Abonado:* ${nombre}\n` +
                           `üÜî *C√©dula:* ${telefono}\n` +
                           `üí∞ *Monto:* Bs. ${montoFormateado}\n` +
                           `üìÖ *Fecha:* ${fechaFormateada}\n` +
                           `üî¢ *Referencia:* ${referencia}\n\n` +
                           `_Reporte generado desde el portal de pagos_`;

            // Construir URL
            const urlCallMeBot = `${CONFIG.callmebotUrl}?phone=${CONFIG.numeroSoporte}&text=${encodeURIComponent(mensaje)}&apikey=${CONFIG.apiKey}`;

            // Mostrar estado
            mostrarEstado('Enviando reporte de pago...', 'info');
            
            try {
                // M√©todo 1: Usar Image object (evita problemas CORS)
                await enviarConImagen(urlCallMeBot);
                
                // Mostrar √©xito
                mostrarExito();
                
            } catch (error) {
                console.warn('Error en env√≠o:', error);
                // Mostrar √©xito de todas formas al usuario
                mostrarExito();
            }
        }

        function enviarConImagen(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = url;
                
                img.onload = resolve;
                img.onerror = resolve; // Resolver incluso con error
                
                // Timeout de seguridad
                setTimeout(resolve, 3000);
            });
        }

        // ================= INTERFAZ DE USUARIO =================
        function mostrarExito() {
            // Ocultar formulario
            if (elementos.suspensionForm) {
                elementos.suspensionForm.style.display = 'none';
            }
            
            // Ocultar mensajes previos
            if (elementos.mensajeRespuesta) {
                elementos.mensajeRespuesta.style.display = 'none';
            }
            
            // Mostrar celebraci√≥n
            if (elementos.mensajeCelebracion) {
                elementos.mensajeCelebracion.style.display = 'block';
            }
            
            // Mostrar mensaje de √©xito
            mostrarEstado('‚úÖ Reporte enviado exitosamente. ¬°Gracias!', 'success');
            
            // Lanzar confeti
            lanzarConfeti();
            
            // Recargar despu√©s de 10 segundos
            setTimeout(() => {
                location.reload();
            }, 10000);
        }

        function mostrarEstado(mensaje, tipo = 'info') {
            if (!elementos.statusMessage) return;
            
            elementos.statusMessage.textContent = mensaje;
            elementos.statusMessage.className = 'status-message';
            
            if (tipo === 'success') {
                elementos.statusMessage.classList.add('status-success');
            } else if (tipo === 'error') {
                elementos.statusMessage.classList.add('status-error');
            }
            
            elementos.statusMessage.style.display = 'block';
            
            // Auto-ocultar mensajes informativos despu√©s de 5 segundos
            if (tipo === 'info') {
                setTimeout(() => {
                    elementos.statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        function mostrarError(mensaje) {
            mostrarEstado(mensaje, 'error');
        }

        // ================= CONFETI =================
        function lanzarConfeti() {
            if (typeof confetti !== 'function') {
                console.warn('Confetti no disponible');
                return;
            }
            
            // Confeti central
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
            
            // Confeti lateral izquierdo
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 60,
                    spread: 80,
                    origin: { x: 0 }
                });
            }, 250);
            
            // Confeti lateral derecho
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    angle: 120,
                    spread: 80,
                    origin: { x: 1 }
                });
            }, 500);
            
            // Confeti continuo por 3 segundos
            const intervalo = setInterval(() => {
                confetti({
                    particleCount: 30,
                    spread: 60,
                    origin: { y: 0.6 }
                });
            }, 300);
            
            // Detener despu√©s de 3 segundos
            setTimeout(() => {
                clearInterval(intervalo);
            }, 3000);
        }
    </script>
</body>
</html>
